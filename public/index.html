<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Catch The Clown — Multiplayer</title>
  <style>
    :root{--bg:#0f172a;--card:#0b1220;--accent:#10b981}
    body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#071028 0%, #071a2b 100%);color:#cbd5e1;display:flex;align-items:center;justify-content:center;height:100vh}
    .app{width:920px;max-width:96vw;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    h1{margin:0 0 12px;font-size:20px}
    .row{display:flex;gap:12px}
    .panel{background:rgba(255,255,255,0.02);padding:14px;border-radius:8px;flex:1}
    input,button,select,textarea{font-size:14px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    button{cursor:pointer;background:var(--accent);color:#022; border:none}
    .players{margin-top:8px}
    .player{padding:6px 8px;background:rgba(255,255,255,0.02);border-radius:6px;margin-bottom:6px}
    .center{text-align:center}
    .clue-list{max-height:200px;overflow:auto;margin-top:8px}
    .big{font-size:18px}
    .secret{font-weight:700;color:#f8fafc;margin-top:6px}
  </style>
</head>
<body>
  <div class="app">
    <h1>Catch The Clown — Multiplayer (Prototype)</h1>

    <div id="lobby" class="row">
      <div class="panel" style="flex:0.6">
        <div><strong>Create or Join</strong></div>
        <div style="margin-top:8px">
          <input id="nameInput" placeholder="Your name" />
          <button id="createBtn">Create Room</button>
        </div>
        <div style="margin-top:8px">or join room id: <input id="joinRoomInput" placeholder="room id" style="width:140px" /> <button id="joinBtn">Join</button></div>

        <div class="players" id="playersList"></div>

        <div style="margin-top:12px">
          <div id="hostControls" style="display:none">
            <button id="startGameBtn">Start Game (Host)</button>
          </div>
        </div>

        <div style="margin-top:8px;color:#94a3b8;font-size:13px">Invite link: <span id="inviteLink">—</span></div>
      </div>

      <div class="panel" style="flex:0.4">
        <div id="statusBox"><em>Not connected</em></div>
        <div style="margin-top:8px">Room ID: <strong id="roomIdView">—</strong></div>
        <div style="margin-top:12px"><strong>Phase:</strong> <span id="phaseView">lobby</span></div>
        <div style="margin-top:12px"><strong>Category:</strong> <span id="categoryView">—</span></div>
        <div style="margin-top:12px"><strong>Secret (investigators only):</strong> <div id="secretView" class="secret">—</div></div>
      </div>
    </div>

    <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0" />

    <div id="gameArea">
      <div class="row">
        <div class="panel">
          <div><strong>Your Role:</strong> <span id="roleView">—</span></div>
          <div style="margin-top:8px">
            <label>Type your clue (one short word/phrase)</label>
            <input id="clueInput" placeholder="e.g. dramatic, red, 1995..." />
            <button id="submitClueBtn">Submit Clue</button>
          </div>

          <div class="clue-list" id="clueList"></div>
        </div>

        <div class="panel">
          <div><strong>Discussion + Voting</strong></div>
          <div style="margin-top:8px">Vote who you think is the impostor:</div>
          <select id="voteSelect"></select>
          <button id="voteBtn">Vote</button>

          <div style="margin-top:12px" id="revealBox"></div>
        </div>
      </div>
    </div>

    <div style="margin-top:12px" class="center"><small>Prototype — no accounts, in-memory rooms. Use a stable hosting for public play.</small></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let currentRoom = null; let myName = null; let isHost = false;

    const $ = id => document.getElementById(id);
    $('createBtn').onclick = ()=>{
      myName = $('nameInput').value.trim() || 'Player'+Math.floor(Math.random()*1000);
      socket.emit('createRoom', ({roomId}) => {
        currentRoom = roomId; $('roomIdView').textContent = roomId; $('inviteLink').textContent = location.origin + '/?room=' + roomId;
        joinAs(roomId, myName);
      });
    };

    $('joinBtn').onclick = ()=>{
      myName = $('nameInput').value.trim() || 'Player'+Math.floor(Math.random()*1000);
      const rid = $('joinRoomInput').value.trim();
      if(!rid) return alert('enter room id');
      joinAs(rid, myName);
    };

    // auto-join if ?room= in URL
    const params = new URLSearchParams(location.search);
    if(params.get('room')){
      $('joinRoomInput').value = params.get('room');
    }

    function joinAs(roomId, name){
      socket.emit('joinRoom', {roomId, name}, (res)=>{
        if(!res.ok) return alert(res.error || 'failed to join');
        currentRoom = roomId; $('roomIdView').textContent = roomId; $('statusBox').textContent = 'Connected as ' + name; $('inviteLink').textContent = location.origin + '/?room=' + roomId;
      });
    }

    socket.on('lobbyUpdate', ({players, host})=>{
      $('playersList').innerHTML = '<strong>Players</strong>' + players.map(p=>`<div class="player">${p}</div>`).join('');
      isHost = (socket.id === host);
      $('hostControls').style.display = isHost ? 'block' : 'none';
      $('startGameBtn').onclick = ()=>{ socket.emit('startGame', {roomId: currentRoom}, (res)=>{ if(!res.ok) alert(res.error||'failed'); }); };

      // populate vote select
      const sel = $('voteSelect'); sel.innerHTML = '<option value="">-- choose --</option>' + players.map(p=>`<option value="${p}">${p}</option>`).join('');
    });

    socket.on('phase', ({phase, category})=>{
      $('phaseView').textContent = phase;
      if(phase==='clue'){
        $('categoryView').textContent = category || '—';
        $('clueInput').disabled = false; $('submitClueBtn').disabled = false;
        $('roleView').textContent = '—'; $('secretView').textContent = '—'; $('revealBox').innerHTML = '';
      } else if(phase==='voting'){
        $('clueInput').disabled = true; $('submitClueBtn').disabled = true;
      }
    });

    socket.on('gameStarted', ({role, category, secret})=>{
      $('roleView').textContent = role;
      $('categoryView').textContent = category || '—';
      if(secret) $('secretView').textContent = secret; else $('secretView').textContent = '(you are the impostor — you do NOT see the secret)';
      $('phaseView').textContent = 'clue';
    });

    $('submitClueBtn').onclick = ()=>{
      const clue = $('clueInput').value.trim();
      if(!currentRoom) return alert('not in room');
      socket.emit('submitClue', {roomId: currentRoom, clue}, (res)=>{ if(res.ok){ $('clueInput').value=''; } });
    };

    socket.on('cluesUpdate', ({clues})=>{
      $('clueList').innerHTML = clues.map(c=>`<div class="player"><strong>${c.name}:</strong> ${c.clue}</div>`).join('');
    });

    $('voteBtn').onclick = ()=>{
      const v = $('voteSelect').value; if(!v) return alert('pick someone');
      socket.emit('castVote', {roomId: currentRoom, votedName: v}, (res)=>{ if(res.ok) { $('revealBox').innerHTML = '<em>Vote cast. Waiting for others...</em>'; } });
    };

    socket.on('reveal', ({chosen, isImpostor, impostorName, secret})=>{
      const box = $('revealBox');
      box.innerHTML = `<div class="big">Voted: <strong>${chosen}</strong></div>` +
        `<div style="margin-top:8px">Impostor: <strong>${impostorName}</strong></div>` +
        `<div style="margin-top:8px">Secret element: <strong>${secret}</strong></div>` +
        `<div style="margin-top:10px;font-weight:700;color:${isImpostor? '#10b981':'#f97316'}">${isImpostor? 'Players guessed correctly!':'Players guessed wrong.'}</div>`;
    });

    // simple status
    socket.on('connect', ()=>{ $('statusBox').textContent = 'Connected'; });
    socket.on('disconnect', ()=>{ $('statusBox').textContent = 'Disconnected'; });
  </script>
</body>
</html>
