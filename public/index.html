<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Catch The Clown â€” Multiplayer</title>
  <style>
    :root{--bg:#0f172a;--card:#0b1220;--accent:#10b981;--red:#f97316;}
    body{
      margin:0;
      font-family:Inter,system-ui,Arial;
      background:linear-gradient(180deg,#071028 0%, #071a2b 100%);
      color:#cbd5e1;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      padding: 20px 0;
    }
    .app{
      width:920px;
      max-width:96vw;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding:18px;
      border-radius:12px;
      box-shadow:0 8px 30px rgba(2,6,23,0.6);
    }
    h1{margin:0 0 12px;font-size:20px}
    .row{display:flex;gap:12px}
    .panel{background:rgba(255,255,255,0.02);padding:14px;border-radius:8px;flex:1}
    input,button,select,textarea{
      font-size:14px;
      padding:8px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.06);
      background:transparent;
      color:inherit
    }
    button{cursor:pointer;background:var(--accent);color:#022; border:none}
    .players{margin-top:8px}
    .player{padding:6px 8px;background:rgba(255,255,255,0.02);border-radius:6px;margin-bottom:6px}
    .center{text-align:center}
    .clue-list{max-height:200px;overflow-y:auto;margin-top:8px}
    .big{font-size:18px}
    .secret{font-weight:700;color:#f8fafc;margin-top:6px}
    .chat-msg { margin-bottom: 4px; }

    /* New Timer/Turn Styles */
    #turnStatus {
        padding: 8px 12px;
        background: rgba(255, 153, 0, 0.1);
        border-radius: 6px;
        margin-bottom: 12px;
        border-left: 3px solid var(--red);
    }
    #turnTimer {
        font-weight: 700;
        color: var(--red);
        font-size: 24px;
        margin-left: 8px;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Catch The Clown â€” Multiplayer (Prototype)</h1>

    <div id="lobby" class="row" style="display: flex;">
      <div class="panel" style="flex:0.6">
        <div><strong>Create or Join</strong></div>
        <div style="margin-top:8px">
          <input id="nameInput" placeholder="Your name" />
          <button id="createBtn">Create Room</button>
        </div>
        <div style="margin-top:8px">or join room id: <input id="joinRoomInput" placeholder="room id" style="width:140px" /> <button id="joinBtn">Join</button></div>

        <div class="players" id="playersList"></div>

        <div style="margin-top:12px">
          <div id="hostControls" style="display:none">
            <button id="startGameBtn">Start Game (Host)</button>
          </div>
        </div>

        <div style="margin-top:8px;color:#94a3b8;font-size:13px">Invite link: <span id="inviteLink">â€”</span></div>
      </div>

      <div class="panel" style="flex:0.4">
        <div id="statusBox"><em>Not connected</em></div>
        <div style="margin-top:8px">Room ID: <strong id="roomIdView">â€”</strong></div>
        <div style="margin-top:12px"><strong>Phase:</strong> <span id="phaseView">lobby</span></div>
      </div>
    </div>

    <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0" />

    <div id="gameArea" style="display: none;"> 
      <div class="row">
        <div class="panel">
          
          <div style="margin-top:4px"><strong>Category:</strong> <span id="categoryView">â€”</span></div>
          <div style="margin-top:8px"><strong>Secret (investigators only):</strong> <div id="secretView" class="secret">â€”</div></div>
          
          <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0" />
          
          <div><strong>Your Role:</strong> <span id="roleView">â€”</span></div>
          
          <div id="turnStatus" style="display: none; margin-top: 12px;">
            It's <strong id="currentPlayerName">Player</strong>'s turn. (<span id="cluesRemainingCount">X</span> clues left)
            <span id="turnTimer">20</span>s
          </div>
          <div style="margin-top:8px">
            <label>Type your clue (one short word/phrase)</label>
            <input id="clueInput" placeholder="e.g. dramatic, red, 1995..." disabled />
            <button id="submitClueBtn" disabled>Submit Clue</button>
          </div>

          <div class="clue-list" id="clueList"></div>
        </div>

        <div class="panel">
          <div><strong>Discussion + Voting</strong></div>
          
          <div style="margin-top:8px; height: 180px; background:rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; overflow-y: scroll;" id="chatLog">
          </div>
          <div style="display:flex; gap: 4px; margin-top: 4px;">
            <input id="chatInput" placeholder="Type message..." style="flex:1" disabled />
            <button id="chatSendBtn" disabled>Send</button>
          </div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0" />

          <div style="margin-top:8px">Vote who you think is the impostor:</div>
          <select id="voteSelect"></select>
          <button id="voteBtn">Vote</button>

          <div style="margin-top:12px" id="revealBox"></div>
        </div>
        
      </div>
    </div>

    <div style="margin-top:12px" class="center"><small>Prototype â€” no accounts, in-memory rooms. Use a stable hosting for public play.</small></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let currentRoom = null; 
    let myName = null; 
    let isHost = false;
    let mySocketId = socket.id; // Store initial ID
    let currentTurnId = null; // New variable to track whose turn it is

    const $ = id => document.getElementById(id);
    
    // --- UI VIEW TOGGLE FUNCTION ---
    function setPhaseView(view) {
        $('lobby').style.display = (view === 'lobby') ? 'flex' : 'none';
        $('gameArea').style.display = (view === 'game') ? 'block' : 'none';
    }
    setPhaseView('lobby'); 
    // -----------------------------

    $('createBtn').onclick = ()=>{
      myName = $('nameInput').value.trim() || 'Player'+Math.floor(Math.random()*1000);
      if (myName.length < 2) return alert('Name must be at least 2 characters.');
      socket.emit('createRoom', ({roomId}) => {
        currentRoom = roomId; 
        $('roomIdView').textContent = roomId; 
        $('inviteLink').textContent = location.origin + '/?room=' + roomId;
        joinAs(roomId, myName);
      });
    };

    $('joinBtn').onclick = ()=>{
      myName = $('nameInput').value.trim() || 'Player'+Math.floor(Math.random()*1000);
      if (myName.length < 2) return alert('Name must be at least 2 characters.');
      const rid = $('joinRoomInput').value.trim();
      if(!rid) return alert('enter room id');
      joinAs(rid, myName);
    };

    const params = new URLSearchParams(location.search);
    if(params.get('room')){
      $('joinRoomInput').value = params.get('room');
    }

    function joinAs(roomId, name){
      socket.emit('joinRoom', {roomId, name}, (res)=>{
        if(!res.ok) return alert(res.error || 'failed to join');
        currentRoom = roomId; 
        $('roomIdView').textContent = roomId; 
        $('statusBox').textContent = 'Connected as ' + name; 
        $('inviteLink').textContent = location.origin + '/?room=' + roomId;
        setPhaseView('lobby');
      });
    }

    // Update socket.id on connect/reconnect
    socket.on('connect', ()=>{ 
        $('statusBox').textContent = 'Connected'; 
        mySocketId = socket.id;
    });

    socket.on('lobbyUpdate', ({players, host})=>{
      $('playersList').innerHTML = '<strong>Players</strong>' + players.map(p=>`<div class="player">${p}</div>`).join('');
      isHost = (mySocketId === host);
      $('hostControls').style.display = isHost ? 'block' : 'none';
      $('startGameBtn').onclick = ()=>{ 
        socket.emit('startGame', {roomId: currentRoom}, (res)=>{ 
          if(!res.ok) alert(res.error||'failed to start game'); 
        }); 
      };

      const sel = $('voteSelect'); 
      sel.innerHTML = '<option value="">-- choose --</option>' + players.map(p=>`<option value="${p}">${p}</option>`).join('');
    });

    // NEW: Turn Update Handler
    socket.on('turnUpdate', ({currentPlayerId, currentPlayerName, timeRemaining, cluesRemaining}) => {
        currentTurnId = currentPlayerId;

        $('turnStatus').style.display = 'block';
        $('currentPlayerName').textContent = currentPlayerName;
        $('cluesRemainingCount').textContent = cluesRemaining - 1; // Remaining after current turn
        $('turnTimer').textContent = timeRemaining;

        const isMyTurn = (mySocketId === currentPlayerId);
        $('clueInput').disabled = !isMyTurn;
        $('submitClueBtn').disabled = !isMyTurn;
        
        if (isMyTurn) {
            $('clueInput').focus();
        }
    });

    // NEW: Timer Tick Handler
    socket.on('timerTick', ({timeRemaining}) => {
        $('turnTimer').textContent = timeRemaining;
    });
    
    socket.on('phase', ({phase, category})=>{
      $('phaseView').textContent = phase;
      $('revealBox').innerHTML = ''; 
      $('voteBtn').disabled = false; // Enable voting when phase starts

      if(phase==='clue'){
        $('categoryView').textContent = category || 'â€”';
        $('clueList').innerHTML = '';
        $('chatLog').innerHTML = '';
        
        // Input enabled/disabled by 'turnUpdate'
        $('chatInput').disabled = true; 
        $('chatSendBtn').disabled = true;

      } else if(phase==='voting'){
        // Disable clue inputs
        $('clueInput').disabled = true; 
        $('submitClueBtn').disabled = true;
        $('turnStatus').style.display = 'none';

        // ENABLE CHAT CONTROLS during discussion
        $('chatInput').disabled = false;
        $('chatSendBtn').disabled = false;
        
      } else {
        // Disable everything during reveal/lobby
        $('clueInput').disabled = true;
        $('submitClueBtn').disabled = true;
        $('chatInput').disabled = true;
        $('chatSendBtn').disabled = true;
        $('turnStatus').style.display = 'none';
      }
    });

    socket.on('gameStarted', ({role, category, secret})=>{
      setPhaseView('game');
      $('roleView').textContent = role;
      $('categoryView').textContent = category || 'â€”';
      if(secret) $('secretView').textContent = secret; 
      else $('secretView').textContent = '(you are the impostor â€” you do NOT see the secret)';
      
      $('clueList').innerHTML = '';
      $('chatLog').innerHTML = '';
      $('revealBox').innerHTML = '';
      $('voteSelect').value = '';
    });

    $('submitClueBtn').onclick = ()=>{
      const clue = $('clueInput').value.trim();
      if(!currentRoom) return alert('not in room');
      if (clue.length < 1) return alert('Please enter a clue.');

      socket.emit('submitClue', {roomId: currentRoom, clue}, (res)=>{ 
        if(res.ok){ 
          $('clueInput').value=''; 
          // Client will be disabled by the next 'turnUpdate'
        } else {
            alert(res.error);
        }
      });
    };

    socket.on('cluesUpdate', ({clues})=>{
      const submittedClues = clues.filter(c => c.clue !== null); 
      $('clueList').innerHTML = submittedClues.map(c=>`<div class="player"><strong>${c.name}:</strong> ${c.clue}</div>`).join('');
    });
    
    // --- CHAT LOGIC ---
    function sendChatMessage() {
        const msg = $('chatInput').value.trim();
        if (msg && currentRoom) {
            socket.emit('chatMessage', { roomId: currentRoom, message: msg });
            $('chatInput').value = '';
        }
    }

    $('chatSendBtn').onclick = sendChatMessage;

    $('chatInput').onkeypress = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendChatMessage();
        }
    };
    
    socket.on('newChatMessage', ({ name, message }) => {
      const chatLog = $('chatLog');
      const msgElem = document.createElement('div');
      msgElem.className = 'chat-msg';
      msgElem.innerHTML = `<span style="color:#f97316; font-weight: 500;">${name}:</span> ${message}`;
      chatLog.appendChild(msgElem);
      chatLog.scrollTop = chatLog.scrollHeight; 
    });
    // --- END CHAT LOGIC ---

    $('voteBtn').onclick = ()=>{
      const v = $('voteSelect').value; 
      if(!v) return alert('pick someone');
      
      socket.emit('castVote', {roomId: currentRoom, votedName: v}, (res)=>{ 
        if(res.ok) { 
          $('revealBox').innerHTML = '<em>Vote cast. Waiting for others...</em>'; 
          $('voteBtn').disabled = true;
        } else {
            alert(res.error || 'Failed to cast vote.');
        }
      });
    };

    socket.on('reveal', ({chosen, isImpostor, impostorName, secret})=>{
      const box = $('revealBox');
      const resultText = isImpostor ? 
        '<div style="color:#10b981">ðŸŽ‰ **Players guessed correctly!** ðŸŽ‰</div>' : 
        '<div style="color:#f97316">ðŸ˜” **Players guessed wrong.** ðŸ˜”</div>';
        
      box.innerHTML = `<div class="big">Voted Off: <strong>${chosen}</strong></div>` +
        `<div style="margin-top:8px">Impostor Was: <strong>${impostorName}</strong></div>` +
        `<div style="margin-top:8px">Secret Element Was: <strong>${secret}</strong></div>` +
        `<div style="margin-top:10px;font-weight:700;">${resultText}</div>` +
        `<div style="margin-top:15px"><button onclick="window.location.reload();">Play Again</button></div>`; // Simple reload to reset state

        $('voteBtn').disabled = true;
        $('chatInput').disabled = true;
        $('chatSendBtn').disabled = true;
    });

    socket.on('disconnect', ()=>{ $('statusBox').textContent = 'Disconnected'; });
  </script>
</body>
</html>
